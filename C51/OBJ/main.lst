C51 COMPILER V9.53.0.0   MAIN                                                              01/16/2025 15:40:09 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\OBJ\main.obj
COMPILER INVOKED BY: C:\Program Files (x86)\KEIL\C51\BIN\C51.EXE main.c LARGE OMF2 OPTIMIZE(3,SIZE) BROWSE INCDIR(..\USE
                    -R;..\FUNC_HANDLER;..\GUI_APP;..\HANDWARE\UART2) DEBUG PRINT(..\OBJ\main.lst) TABS(2) OBJECT(..\OBJ\main.obj)

line level    source

   1          #include "sys.h"
   2          #include "uart2.h"
   3          #include <string.h>
   4          extern  u8 modbus_addresses[5];     // –ê–¥—Ä–µ—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   5          extern  u16 start_reg;              // –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä
   6          extern  u16 num_reg;                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
   7          
   8          extern volatile u32 rcv_timer;
   9          extern volatile  u32 sys_tick;
  10          extern u8  uart2_step;
  11          
  12          #define FIRST_TXT    "DGUS Tool\0\0"
  13          #define TEST_TXT     "DGUS TEST TEXT\0\0"
  14          #define INT_TXT    "INERRUPT \0\0"
  15          #define WHILE_TXT    "WHILE___ \0\0"
  16          
  17          
  18          
  19          // –ü—Ä–æ—Ç–æ—Ç–∏–ø —Ñ—É–Ω–∫—Ü–∏–∏
  20          void modbus_requests(ModbusRequest *requests);
  21          
  22          void main(void)
  23          {   
  24   1      
  25   1      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `xdata`
  26   1      idata  ModbusRequest request[6] = {
  27   1          {0x2, 0x3, 0x0000, 0x4},   // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1
  28   1          {0x4, 0x3, 0x0000, 0x2},   // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 2
  29   1          {0x3, 0x3, 0x0002, 0x2},   // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 3
  30   1          {0x1, 0x3, 0x0000, 0x2},   // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 4
  31   1          {0x5, 0x3, 0x00FD, 0x1},  // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 5
  32   1          {0x6, 0x3, 0x002F, 0x1}   // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 6
  33   1      };
  34   1      
  35   1       idata  ModbusRequest temp_request;
  36   1        u8 send_buff[8]={0, };
  37   1        u32 polling_timer=0;                    // –¢–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
  38   1        u8 polling_state;                     // –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ä–æ—Å–∞: 0 - –æ—Ç–ø—Ä–∞–≤–∫–∞, 1 - –æ–∂–
             -∏–¥–∞–Ω–∏–µ
  39   1        u16 len;
  40   1        u16 i;
  41   1        u8 buff[48]={0, };
  42   1        u16 send_reg[16]={0, };
  43   1        u16 recv_len;
  44   1        idata u8 command_value; // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
  45   1        float temperature;
  46   1        u16 rawValue;
  47   1        xdata ModbusPacket receivedPacket;
  48   1        u16 freq;
  49   1        u16 receive_cmd=0;
  50   1      xdata u16 receive_adr=0;
  51   1      
  52   1           xdata u16 result=0;  
  53   1           sys_init();//System initialization
C51 COMPILER V9.53.0.0   MAIN                                                              01/16/2025 15:40:09 PAGE 2   

  54   1           uart2_init(9600);//Initialize serial port 2
  55   1           current_device = 0;
  56   1           polling_state=0;
  57   1        while(1){   
  58   2          
  59   2          
  60   2          
  61   2          if(((sys_tick-rcv_timer)>=300000)&&(polling_state == 1)&&(uart2_rx_sta)){uart2_rx_sta |= UART2_PACKET_OK
             -; }; // –¢–∞–π–º–∞—É—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö 
  62   2              
  63   2                
  64   2          
  65   2          if(uart2_rx_sta & UART2_PACKET_OK)
  66   2          {
  67   3              
  68   3            len = uart2_rx_sta&UART2_PACKET_LEN;
  69   3              
  70   3            sys_write_vp(0x2069, (u16*)&len, 2);
*** WARNING C182 IN LINE 70 OF main.c: pointer to different objects
  71   3        
  72   3            recv_len = 0;
  73   3            for(i=0;i<len;i++)
  74   3            {
  75   4              recv_len += sprintf(buff+recv_len,"%02X ",(u16)uart2_buf[i]);
  76   4            }
  77   3            sys_write_vp(0x2010,"                                ",16);
  78   3            sys_write_vp(0x2010,buff,recv_len/2+2);
  79   3            for(i=0;i<48;i++)
  80   3            {
  81   4              buff[i]=0;
  82   4            }
  83   3            
  84   3            result=parseModbusPacket(&uart2_buf,len,(ModbusPacket*)&receivedPacket);    
  85   3             sys_write_vp(0x2071, &result, 1);
*** WARNING C182 IN LINE 85 OF main.c: pointer to different objects
  86   3             if (result==1) {   
  87   4                   sys_write_vp(0x2096, "OK    \n", 4);
  88   4             
  89   4             switch (receivedPacket.rcv_address) {
  90   5      
  91   5                 case 0x01: 
  92   5                   
  93   5                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö
  94   5                          if (receivedPacket.rcv_dataLength >= 2) {
  95   6                              // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–π —Ä–µ–≥–∏—Å—Ç—Ä)
  96   6                              rawValue = (receivedPacket.rcv_data[0] << 8) | receivedPacket.rcv_data[1];
  97   6                              if (rawValue & 0x8000) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞–∫ —á–∏—Å–ª–∞
  98   7                                  rawValue = rawValue - 65536; // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  99   7                              }
 100   6                             temperature = rawValue / 10.0; // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
 101   6                             sys_write_vp(0x2005,(u8*)&temperature,2);    
 102   6                             } else {
 103   6                            
 104   6                              }
 105   5                          break;
 106   5                              
 107   5                     case 0x02:           
 108   5                        
 109   5      
 110   5                       if (receivedPacket.rcv_dataLength >= 2) {
 111   6                            
 112   6                          // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–π —Ä–µ–≥–∏—Å—Ç—Ä)
C51 COMPILER V9.53.0.0   MAIN                                                              01/16/2025 15:40:09 PAGE 3   

 113   6                             freq = (receivedPacket.rcv_data[0] << 8) | receivedPacket.rcv_data[1];  
 114   6                        
 115   6                              sys_write_vp(0x2007,(u16*)&freq,2);     
*** WARNING C182 IN LINE 115 OF main.c: pointer to different objects
 116   6                             } else {
 117   6                            
 118   6                              }
 119   5                          break;               
 120   5                 
 121   5                    default:
 122   5                  break;
 123   5             }
 124   4             
 125   4             
 126   4             
 127   4             
 128   4             }else if (result == 99) {
 129   4                  sys_write_vp(0x2096, "Lenght\n", 4);
 130   4                
 131   4              }else if (result == 98) {
 132   4                  sys_write_vp(0x2096, "CRC   \n", 4);
 133   4                
 134   4                
 135   4              uart2_rx_sta = 0;
 136   4              len=0;
 137   4             
 138   4             for(i=0;i<UART2_PACKET_MAX_LEN;i++)
 139   4            {
 140   5              uart2_buf[i]=0;
 141   5            }
 142   4             
 143   4             
 144   4            rcv_complete=1;
 145   4                
 146   4              }else {
 147   4                  sys_write_vp(0x2096, "ERROR\n", 4);
 148   4              }
 149   3            
 150   3            
 151   3              uart2_rx_sta = 0;
 152   3              len=0;
 153   3             
 154   3             for(i=0;i<UART2_PACKET_MAX_LEN;i++)
 155   3            {
 156   4              uart2_buf[i]=0;
 157   4            }
 158   3             
 159   3             
 160   3            rcv_complete=1;
 161   3          }
 162   2         
 163   2          
 164   2        
 165   2          
 166   2      if (polling_state==0) {
 167   3             if (current_device >= 6) {
 168   4                 current_device = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å, –µ—Å–ª–∏ –æ–Ω –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—
             -Ä–∞–Ω–∏—Ü—ã
 169   4                }
 170   3        
 171   3                
 172   3          sys_delay_ms(5);
C51 COMPILER V9.53.0.0   MAIN                                                              01/16/2025 15:40:09 PAGE 4   

 173   3          temp_request = request[current_device];
 174   3          sys_write_vp(0x2000,(u8*)&current_device,1);
 175   3          command_value = temp_request.command; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
 176   3          sys_write_vp(0x2001, &temp_request.command, 1); // –ó–∞–ø–∏—Å—å –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
*** WARNING C182 IN LINE 176 OF main.c: pointer to different objects
 177   3          sys_write_vp(0x2002, &temp_request.start_register, 1); // –ó–∞–ø–∏—Å—å –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞
*** WARNING C182 IN LINE 177 OF main.c: pointer to different objects
 178   3          data_len=(temp_request.num_registers * 2)+5;  
 179   3          sys_write_vp(0x2003,(u16*)&data_len, 2);  
*** WARNING C182 IN LINE 179 OF main.c: pointer to different objects
 180   3          sys_write_vp(0x2004, &temp_request.address, 1);
*** WARNING C182 IN LINE 180 OF main.c: pointer to different objects
 181   3          polling_timer=200000; 
 182   3          polling_state=1;
 183   3          modbus_requests((ModbusRequest*)&temp_request);
 184   3                
 185   3            rcv_timer=sys_tick;
 186   3             }
 187   2      
 188   2            polling_timer--;
 189   2          
 190   2          
 191   2          // –°–æ—Å—Ç–æ—è–Ω–∏–µ 1: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
 192   2          if (polling_state == 1) {
 193   3              // –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç
 194   3            
 195   3              if (rcv_complete==1) {
 196   4                  sys_write_vp(0x2042, "Received        \n", 9);      
 197   4                  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
 198   4                  current_device=current_device+1;
 199   4                  polling_state = 0;  // –í–æ–∑–≤—Ä–∞—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
 200   4                  rcv_complete=0;
 201   4                  polling_timer=200000;
 202   4                  rcv_timer=sys_tick;
 203   4              }
 204   3              // –ï—Å–ª–∏ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ
 205   3               if (polling_timer ==0) {
 206   4                  // –õ–æ–≥–∏—Ä—É–µ–º —Ç–∞–π–º–∞—É—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
 207   4                  sys_write_vp(0x2042, "Timeout         \n", 9);
 208   4           
 209   4                  for(i=0;i<48;i++)
 210   4                  {
 211   5                    buff[i]=0;
 212   5                  }
 213   4                  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
 214   4                  current_device=current_device+1;
 215   4                  polling_state = 0;  // –í–æ–∑–≤—Ä–∞—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
 216   4                  rcv_complete=0;
 217   4                  rcv_timer=sys_tick;
 218   4              }     
 219   3          } 
 220   2        }
 221   1          
 222   1      }
 223          
 224          
 225          
 226          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1479    ----
C51 COMPILER V9.53.0.0   MAIN                                                              01/16/2025 15:40:09 PAGE 5   

   CONSTANT SIZE    =    242    ----
   XDATA SIZE       =   ----     183
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----      57
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  7 WARNING(S),  0 ERROR(S)
